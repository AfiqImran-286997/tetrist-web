<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport"
       content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
 <title>Tetris - Web Version</title>

 <!-- Pyodide to run main.py -->
 <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

 <style>
   /* ---------- GLOBAL touch/selection hardening ---------- */
   html, body {
     font-size:16px;
     touch-action:manipulation;
     -webkit-user-select:none; user-select:none;
     -webkit-touch-callout:none;
     margin:0;
     background:#000;
     color:#fff;
     min-height:100vh;
   }
   * { -webkit-tap-highlight-color: transparent; }

   .wrap, #gameArea, canvas, h1, p, table, th, td, button {
     -webkit-user-select:none; user-select:none;
     -webkit-touch-callout:none;
   }
   button, input, select, textarea {
     touch-action:manipulation;
     -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
     -webkit-user-select:none; user-select:none;
   }

   :root{
     --gap: 12px;
     --logoW-desktop: 420px;
     --logoW-mobile: 70vmin;
   }

   body{ text-align:center; font-family:Arial, sans-serif; }
   .wrap { max-width:900px; margin:0 auto; padding:10px 16px; }
   h1 { margin:20px 0; text-shadow:0 2px 6px rgba(0,0,0,.6); }

   .card{
     display:inline-block;
     padding:18px;
     border-radius:10px;
     border:1px solid rgba(255,255,255,.22);
     background:rgba(0,0,0,.60);
     backdrop-filter:saturate(120%) blur(2px);
     -webkit-backdrop-filter:saturate(120%) blur(2px);
   }

   /* --- GAME AREA --- */
   #gameArea{
     position:relative;
     padding-top:0;
     background:transparent !important;
     border-color:transparent !important;
     box-shadow:none !important;
     backdrop-filter:none !important;
     -webkit-backdrop-filter:none !important;
     display:inline-block;
     transform-origin: top center;
     will-change: transform;
     margin-top:-40px;
   }
   /* centered logo behind the game only */
   #gameArea::before{
     content:"";
     position:absolute; inset:0; z-index:0;
     background-repeat:no-repeat; background-position:center center;
     background-image:url("LSS%20tetris%20background.png?v=3");
     background-size: var(--logoW-desktop) auto;
     opacity:0.95; pointer-events:none;
   }
   @media (max-width:600px){
     #gameArea::before{ background-size: var(--logoW-mobile) auto; }
   }
   #gameArea > * { position:relative; z-index:1; }

   canvas{
     border:2px solid rgba(255,255,255,.85);
     margin-top:12px;
     background:transparent;
     width:300px; height:600px; /* logical base; container is scaled */
   }

   .btn { padding:12px 20px; font-size:18px; border:0; border-radius:6px; margin:6px 8px; cursor:pointer; }
   .btn.primary { background:#24d15d; color:#000; }
   .btn.secondary{ background:#2f7ded; color:#fff; }
   .btn.ghost { background:#333; color:#fff; }
   .btn.small { font-size:14px; padding:8px 12px; }

   #loading{ color:#ff0; font-size:18px; min-height:1.4em; }
   #audioStatus{ font:12px/1.2 Arial,sans-serif; color:#eee; min-height:1.2em; margin-top:6px; text-shadow:0 1px 3px rgba(0,0,0,.6); }

   .screen{ display:none; }
   .screen.active{ display:block; }

   #restartBtn{ display:none; margin-top:12px; }

   /* ====== BIGGER, SINGLE-ROW CONTROLS (Phone + PC) ====== */
   #controls{
     margin:6px 0 10px 0;
     display:flex;
     justify-content:center;
     align-items:center;
     flex-wrap:nowrap;          /* force single row */
     gap:14px;
     width:100%;
    transform:translateY(-20px);
   }
   #controls button{
     font-size:36px;            /* big icon */
     padding:18px 26px;         /* big touch target */
     margin:4px;
     border-radius:14px;
     min-width:80px;
     min-height:80px;
     background:#333;
     color:#fff;
     border:2px solid #666;
     box-shadow:0 3px 8px rgba(0,0,0,.5);
     transition:transform .1s, background .2s;
   }
   #controls button:active{ transform:scale(.93); background:#555; }
   #controls button:disabled{ opacity:.5; cursor:not-allowed; }

   @media (max-width:480px){
     #controls button{
       font-size:28px;
       min-width:70px;
       min-height:70px;
       padding:16px 20px;
     }
   }

   table{ border-collapse:collapse; margin:10px auto; width:96%; max-width:620px; }
   th, td{ border:1px solid rgba(255,255,255,.2); padding:8px 10px; text-align:left; background:rgba(0,0,0,.25); }
   th{ background:rgba(0,0,0,.35); }
   tr:nth-child(even) td{ background:rgba(0,0,0,.20) }
   th.sel, td.sel{ width:52px; text-align:center }
   .muted{ opacity:.9; font-size:12px; text-shadow:0 1px 3px rgba(0,0,0,.6) }

   /* ---- Name screen styling ---- */
   #nameInput{
     width:260px; max-width:80vw;
     padding:10px 12px;
     border-radius:8px; border:1px solid #666;
     background:#111; color:#fff;
     font-size:16px;
     text-align:center;
   }
   #playerBadge{
     font-size:13px; opacity:.9; margin-top:6px;
   }
 </style>
</head>
<body>
 <div class="wrap">
   <h1>Tetris - Web Version</h1>

   <!-- Music control -->
   <div class="card" style="margin-bottom:14px">
     <button id="btnMusic" class="btn small ghost" aria-pressed="false" title="Toggle music">üîá Music</button>
     <div id="audioStatus"></div>
   </div>

   <!-- ===== NAME (FIRST RUN) ===== -->
   <section id="screen-name" class="screen active">
     <div class="card" style="min-width:340px">
       <h2>üë§ Player Name</h2>
       <p class="muted" style="max-width:520px">
         Enter your name once. We‚Äôll remember it and use it automatically on the Score Board.
       </p>
       <div style="margin:10px 0 4px">
         <input id="nameInput" maxlength="24" placeholder="Enter name (e.g., Afiq)" />
       </div>
       <div>
         <button id="btnSaveName" class="btn primary">Save & Continue</button>
       </div>
       <p class="muted" style="margin-top:8px">You can change this anytime from the menu.</p>
     </div>
   </section>

   <!-- ===== MENU ===== -->
   <section id="screen-menu" class="screen">
     <div class="card">
       <p id="playerBadge">Player: <strong id="playerNameLabel">‚Äî</strong>
         <button id="btnChangeName" class="btn small ghost" style="margin-left:8px">Change name</button>
       </p>
       <p id="loading" style="color:#ff0; min-height:1.2em">Loading engine‚Ä¶</p>
       <div style="margin-top:12px">
         <button id="btnPlay" class="btn primary">‚ñ∂ Play</button>
         <button id="btnScores" class="btn secondary">üèÜ Score Board</button>
       </div>
     </div>
   </section>

   <!-- ===== GAME ===== -->
   <section id="screen-game" class="screen">
     <div id="gameArea" class="card">
       <p id="gameLoading" style="color:#ff0; min-height:1.2em">Loading game, please wait‚Ä¶</p>
       <canvas id="gameCanvas" width="300" height="450"></canvas><br />
       <button id="restartBtn" class="btn ghost">Restart Game</button>

       <div id="controls">
         <button id="btnLeft"  disabled aria-label="Move left">‚óÄ</button>
         <button id="btnRight" disabled aria-label="Move right">‚ñ∂</button>
         <button id="btnDown"  disabled aria-label="Soft drop">‚ñº</button>
         <button id="btnRotate" disabled aria-label="Rotate">‚ü≥</button>
       </div>

       <div style="margin-top:6px">
         <button id="btnBackFromGame" class="btn small ghost">‚Üê Back to Menu</button>
       </div>
     </div>
   </section>

   <!-- ===== SCOREBOARD ===== -->
   <section id="screen-scores" class="screen">
     <div class="card" style="min-width:340px">
       <h2>üèÜ Score Board</h2>

       <div class="muted" id="cloudStatus">Cloud: <em>checking‚Ä¶</em></div>
       <p class="muted">Top 10 highest scores (cloud)</p>

       <table id="scoresTable">
         <thead>
           <tr>
             <th class="sel">Sel</th><th>#</th><th>Name</th><th>Score</th><th>Date</th>
           </tr>
         </thead>
         <tbody></tbody>
       </table>

       <div>
         <button id="btnCloudClearSelected" class="btn small ghost">Clear Selected</button>
         <button id="btnCloudClearAll" class="btn small ghost">Clear Scores</button>
         <button id="btnBackFromScores" class="btn small ghost">‚Üê Back to Menu</button>
       </div>
     </div>
   </section>
 </div>
<!-- Background music -->
 <audio id="bgm" src="bgm.mp3?v=1" loop preload="auto"></audio>

 <!-- ========================= APP SCRIPT ========================= -->
 <script type="module">
   /* Kill double-tap zoom (extra help for iOS) */
   let __lastTouchEnd = 0;
   document.addEventListener('touchend', function(e){
     const now = Date.now();
     if (now - __lastTouchEnd <= 300) e.preventDefault();
     __lastTouchEnd = now;
   }, {passive:false, capture:true});

   /* Fit the whole game panel to the viewport */
   const gameArea = document.getElementById('gameArea');
   function fitGameToViewport(){
     gameArea.style.transform = 'none';
     const panelW = gameArea.scrollWidth;
     const panelH = gameArea.scrollHeight;
     const vw = Math.max(320, window.innerWidth) - 8;
     const vh = Math.max(320, window.innerHeight) - 8;
     const scale = Math.min(1, vw/panelW, vh/panelH);
     gameArea.style.transform = `scale(${scale})`;
   }
   window.addEventListener('resize', fitGameToViewport);
   window.addEventListener('orientationchange', fitGameToViewport);

   /* ----------------- Music ----------------- */
   const bgm = document.getElementById("bgm");
   const btnMusic = document.getElementById("btnMusic");
   const audioStatus = document.getElementById("audioStatus");
   let ac;
   function ensureAudioContext(){
     try{
       const C = window.AudioContext || window.webkitAudioContext;
       if (C && (!ac || ac.state === "closed")) ac = new C();
       if (ac && ac.state !== "running") ac.resume().catch(()=>{});
     }catch{}
   }
   function setStatus(msg){ audioStatus.textContent = msg || ""; }
   function musicIsPlaying(){ return !bgm.paused && !bgm.ended && bgm.currentTime>0; }
   function updateMusicUI(){
     const m = bgm.muted || bgm.volume===0 || bgm.paused;
     btnMusic.textContent = m ? "üîá Music" : "üîä Music";
     btnMusic.setAttribute("aria-pressed", (!m).toString());
   }
   async function tryStartMusic(){
     ensureAudioContext();
     const pref = localStorage.getItem("musicMuted");
     if (pref === "true"){ updateMusicUI(); setStatus("Music: muted (saved)"); return; }
     try{
       bgm.muted=false; bgm.volume=0.6; await bgm.play();
       updateMusicUI(); setStatus("Music: playing");
     }catch{
       updateMusicUI(); setStatus("Music: press Music to start (autoplay)");
     }
   }
   function toggleMusic(){
     ensureAudioContext();
     if (musicIsPlaying()){
       bgm.pause(); bgm.muted=true; localStorage.setItem("musicMuted","true"); setStatus("Music: paused");
     } else {
       bgm.muted=false; bgm.volume=0.6;
       bgm.play().then(()=>setStatus("Music: playing")).catch(()=>setStatus("Music: couldn't start"));
       localStorage.setItem("musicMuted","false");
     }
     updateMusicUI();
   }
   btnMusic.addEventListener("click", toggleMusic);
   bgm.addEventListener("canplaythrough", ()=>setStatus("Music: loaded (ready)"));
   bgm.addEventListener("error", ()=>setStatus("Music: ERROR loading bg.mp3"));
   (function initMusicPref(){
     if (localStorage.getItem("musicMuted")==="true") bgm.muted=true;
     updateMusicUI();
     const kick=()=>{tryStartMusic(); window.removeEventListener("pointerdown",kick);};
     window.addEventListener("pointerdown",kick,{once:true});
   })();

   /* ----------------- Screen switching ----------------- */
   function showScreen(id){
     document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
     document.getElementById(id).classList.add('active');
     if (id === 'screen-game'){ setTimeout(fitGameToViewport, 0); }
   }

   /* ----------------- Player name helpers ----------------- */
   const nameInput = document.getElementById('nameInput');
   const playerNameLabel = document.getElementById('playerNameLabel');

   function getPlayerName(){
     const s = (localStorage.getItem('playerName')||'').trim();
     return s || "";
   }
   function setPlayerName(name){
     const clean = (name||"").trim().slice(0,24);
     if (!clean) return false;
     localStorage.setItem('playerName', clean);
     playerNameLabel.textContent = clean;
     return true;
   }
   function requireNameFlowIfNeeded(){
     const saved = getPlayerName();
     if (saved){
       playerNameLabel.textContent = saved;
       showScreen('screen-menu');
     }else{
       showScreen('screen-name');
       setTimeout(()=>nameInput.focus(), 0);
     }
   }

   document.getElementById('btnSaveName').addEventListener('click', ()=>{
     const ok = setPlayerName(nameInput.value);
     if (!ok){ alert('Please enter a name.'); return; }
     showScreen('screen-menu');
   });
   nameInput.addEventListener('keydown', (e)=>{
     if (e.key === 'Enter') document.getElementById('btnSaveName').click();
   });
   document.getElementById('btnChangeName').addEventListener('click', ()=>{
     nameInput.value = getPlayerName();
     showScreen('screen-name');
     setTimeout(()=>nameInput.select(), 0);
   });

   /* ----------------- Firebase (CDN v11 modular) ----------------- */
   import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
   import {
     getFirestore, collection, addDoc, serverTimestamp,
     query, orderBy, limit, deleteDoc, doc, onSnapshot
   } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

   const firebaseConfig = {
     apiKey: "AIzaSyCwtCR3h3Y-KnNFGVNzMFerkapkKgBrqus",
     authDomain: "tetrist-web.firebaseapp.com",
     projectId: "tetrist-web",
     storageBucket: "tetrist-web.firebasestorage.app",
     messagingSenderId: "378076610293",
     appId: "1:378076610293:web:22ad48c19e7af8b00ccfbc",
     measurementId: "G-6JQX0TYB56"
   };
   const app = initializeApp(firebaseConfig);
   const db  = getFirestore(app);

   const ADMIN_PASSWORD = "LSSIsTheBest";
   const cloudStatusEl = document.getElementById("cloudStatus");
   const tbody = document.querySelector("#scoresTable tbody");
   const escapeHtml = (s)=> (s??"").toString().replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
   const fmt = (ts)=> new Date(ts?.seconds? ts.seconds*1000 : Date.now())
     .toLocaleString([], { hour12:true, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });

   let unsubscribeScores = null;
   const topQuery = query(collection(db,"scores"), orderBy("score","desc"), limit(10));

   function attachScoresListener(){
     if (unsubscribeScores) return;
     unsubscribeScores = onSnapshot(topQuery, (snap)=>{
       const rows = [];
       snap.forEach(d => rows.push({ id:d.id, ...d.data() }));
       renderRows(rows);
       cloudStatusEl.innerHTML = 'Cloud: <span style="color:#24d15d">online</span>';
     }, (err)=>{
       console.error("scores listener:", err);
       cloudStatusEl.innerHTML = 'Cloud: <span style="color:#f66">offline / error</span>';
       tbody.innerHTML = '<tr><td class="sel"></td><td colspan="4" style="text-align:center;opacity:.7">Could not load scores (offline?)</td></tr>';
     });
   }
   function detachScoresListener(){ if (unsubscribeScores){ unsubscribeScores(); unsubscribeScores = null; } }

   function renderRows(rows){
     tbody.innerHTML = "";
     if (!rows.length){
       tbody.innerHTML = '<tr><td class="sel"></td><td colspan="4" style="text-align:center;opacity:.7">No scores yet</td></tr>';
       return;
     }
     rows.forEach((r,i)=>{
       const tr = document.createElement("tr");
       tr.innerHTML =
         '<td class="sel"><input type="checkbox" class="selbox cloud" data-docid="'+r.id+'"></td>'+
         '<td>'+(i+1)+'</td>'+
         '<td>'+escapeHtml(r.name||"Player")+'</td>'+
         '<td>'+r.score+'</td>'+
         '<td>'+fmt(r.createdAt)+'</td>';
       tbody.appendChild(tr);
     });
   }

   async function addScoreToCloud(score){
     try{
       const name = getPlayerName() || "Player";
       await addDoc(collection(db,"scores"), {
         name,
         score: Number(score)||0,
         createdAt: serverTimestamp()
       });
     }catch(e){ console.error("addScore:", e); }
   }

   function checkAdmin(label){ const pw = prompt(label+"\nEnter admin password:"); return pw && pw === ADMIN_PASSWORD; }
   function disableCloudButtons(disable, cache){
     const controls = [document.getElementById("btnCloudClearSelected"), document.getElementById("btnCloudClearAll")];
     if (disable){ cache = controls.map(b => b.disabled); controls.forEach(b=>b.disabled = true); return cache; }
     controls.forEach((b,i)=> b.disabled = cache ? cache[i] : false);
   }

   async function cloudDeleteSelected(){
     if (!checkAdmin("Clear SELECTED rows?")) return;
     const btns = disableCloudButtons(true);
     try{
       const checks = Array.from(document.querySelectorAll(".selbox.cloud:checked"));
       if (!checks.length){ alert("Please tick at least one row."); return; }
       await Promise.all(checks.map(c => deleteDoc(doc(db,"scores", c.getAttribute("data-docid")))));
       alert("Deleted "+checks.length+" item(s) from cloud.");
     }catch(e){ console.error(e); alert("Failed to delete selected (see console)."); }
     finally{ disableCloudButtons(false, btns); }
   }

   async function cloudClearAll(){
     if (!checkAdmin("Clear ALL scores that are currently shown?")) return;
     const btns = disableCloudButtons(true);
     try{
       const ids = Array.from(document.querySelectorAll(".selbox.cloud")).map(i=>i.getAttribute("data-docid"));
       if (!ids.length){ alert("No scores to delete."); return; }
       await Promise.all(ids.map(id => deleteDoc(doc(db,"scores", id))));
       alert("Cleared the table‚Äôs scores from cloud.");
     }catch(e){ console.error(e); alert("Failed to clear scores (see console)."); }
     finally{ disableCloudButtons(false, btns); }
   }

   /* ----------------- Pyodide + Game ----------------- */
   let pyodide, gameCode, gameStarted=false;

   // NOTE: Now it uses saved player name automatically. No prompt at game over.
   window.onGameOver = async (score, reason) => {
     setTimeout(async ()=>{
       await addScoreToCloud(score);
       attachScoresListener();
       showScreen('screen-scores');
     }, 50);
   };

   async function preloadEngine(){
     try{
       document.getElementById("loading").innerText = "Loading engine‚Ä¶";
       pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/" });
       const resp = await fetch("main.py?v=" + Date.now(), { cache:"no-store" });
       gameCode = await resp.text();
       document.getElementById("loading").innerText = "Ready!";
     }catch(e){
       console.error(e);
       document.getElementById("loading").innerText = "Failed to load. See console.";
     }
   }
   preloadEngine();
/* Smooth / repeating controls (single tap = one move; hold = repeat) */
   function makeRepeater(element, fireFn, initialDelay = 220, repeatEvery = 55){
     let holding=false, repeating=false, delayT=null, repeatT=null;
     const clearTimers = () => {
       if (delayT)  { clearTimeout(delayT);  delayT  = null; }
       if (repeatT) { clearInterval(repeatT); repeatT = null; }
     };
     const onDown = (e) => {
       e.preventDefault();
       clearTimers(); holding=true; repeating=false;
       delayT = setTimeout(() => {
         if (!holding) return;
         repeating = true; fireFn();
         repeatT = setInterval(fireFn, repeatEvery);
       }, initialDelay);
     };
     const onUp = () => {
       const isTap = holding && !repeating;
       holding=false; clearTimers();
       if (isTap) fireFn();
     };
     element.addEventListener('pointerdown', onDown, { passive:false });
     element.addEventListener('pointerup', onUp);
     element.addEventListener('pointerleave', onUp);
     element.addEventListener('pointercancel', onUp);
     element.addEventListener('click', (e) => e.preventDefault()); // avoid ghost click
   }

   /* UI events */
   document.getElementById("btnPlay").addEventListener("click", async ()=>{
     tryStartMusic();
     showScreen('screen-game');
     if (gameStarted) return;
     gameStarted = true;

     const gl = document.getElementById("gameLoading");
     gl.innerText = "Starting game‚Ä¶";
     await pyodide.runPythonAsync(gameCode);
     gl.innerText = "Game Loaded!";

     document.querySelectorAll("#controls button").forEach(b=>b.disabled=false);
     const callPy = (c)=> pyodide.runPython(c);

     document.getElementById("restartBtn").onclick = () => location.reload();

     makeRepeater(document.getElementById("btnLeft"),
       ()=>callPy('on_key({"key":"ArrowLeft"})'), 130, 50);
     makeRepeater(document.getElementById("btnRight"),
       ()=>callPy('on_key({"key":"ArrowRight"})'), 130, 50);
     makeRepeater(document.getElementById("btnRotate"),
       ()=>callPy('on_key({"key":"ArrowUp"})'), 160, 90);

     const btnDown = document.getElementById("btnDown");
     const downStart = (e)=>{ e.preventDefault(); callPy('start_soft_drop_hold()'); };
     const downEnd   = ()=>{ callPy('stop_soft_drop_hold()'); };
     btnDown.addEventListener("pointerdown", downStart, {passive:false});
     btnDown.addEventListener("pointerup",   downEnd);
     btnDown.addEventListener("pointerleave",downEnd);
     btnDown.addEventListener("pointercancel",downEnd);
     btnDown.addEventListener("click", (e)=>{ e.preventDefault(); callPy('soft_drop_tap()'); });

     fitGameToViewport();
   });

   document.getElementById("btnScores").addEventListener("click", ()=>{
     attachScoresListener();
     showScreen('screen-scores');
   });
   document.getElementById("btnBackFromScores").addEventListener("click", ()=>{
     detachScoresListener();
     showScreen('screen-menu');
   });

   document.getElementById("btnCloudClearSelected").addEventListener("click", cloudDeleteSelected);
   document.getElementById("btnCloudClearAll").addEventListener("click", cloudClearAll);

   document.getElementById("btnBackFromGame").addEventListener("click", ()=> location.reload());
   window.addEventListener("keydown", tryStartMusic, { once:true });

   // On boot: require a name before showing the menu
   requireNameFlowIfNeeded();
 </script>
</body>
</html>
























































