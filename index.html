<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
 <title>Tetris - Web Version</title>

 <!-- Pyodide to run main.py -->
 <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

 <!-- Firebase COMPAT (works without ES modules) -->
 <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

 <style>
   html, body{
     font-size:16px; touch-action:manipulation;
     -webkit-user-select:none; user-select:none; -webkit-touch-callout:none;
     margin:0; background:#000; color:#fff;
     min-height:100vh; height:100svh; overflow:hidden;
   }
   *{ -webkit-tap-highlight-color:transparent; }
   body{ text-align:center; font-family:Arial, sans-serif; }
   .wrap{ max-width:900px; margin:0 auto; padding:10px 16px; }
   h1{ margin:20px 0; text-shadow:0 2px 6px rgba(0,0,0,.6); }
   .card{
     display:inline-block; padding:18px; border-radius:10px;
     border:1px solid rgba(255,255,255,.22);
     background:rgba(0,0,0,.60);
     backdrop-filter:saturate(120%) blur(2px); -webkit-backdrop-filter:saturate(120%) blur(2px);
   }
   #gameArea{
     position:relative; padding-top:8px; margin-top:10px;
     background:transparent !important; border-color:transparent !important; box-shadow:none !important;
     transform-origin:top center; will-change:transform; display:inline-block;
   }
   #gameArea::before{
     content:""; position:absolute; inset:0; z-index:0; pointer-events:none; opacity:.95;
     background-image:url("LSS%20tetris%20background.png?v=3");
     background-repeat:no-repeat; background-position:center center; background-size:420px auto;
   }
   @media (max-width:600px){ #gameArea::before{ background-size:70vmin auto; } }
   #gameArea > *{ position:relative; z-index:1; }

   .backtop{ position:absolute; top:8px; left:8px; z-index:2; padding:6px 10px; }
   canvas{
     border:2px solid rgba(255,255,255,.85); margin-top:36px; background:transparent;
     width:300px; height:600px;  /* logical; container scales */
   }

   .btn{ padding:12px 20px; font-size:18px; border:0; border-radius:6px; margin:6px 8px; cursor:pointer; }
   .btn.primary{ background:#24d15d; color:#000; }
   .btn.secondary{ background:#2f7ded; color:#fff; }
   .btn.ghost{ background:#333; color:#fff; }
   .btn.small{ font-size:14px; padding:8px 12px; }
   #loading{ color:#ff0; font-size:18px; min-height:1.4em; }
   #audioStatus{ font:12px/1.2 Arial,sans-serif; color:#eee; min-height:1.2em; margin-top:6px; text-shadow:0 1px 3px rgba(0,0,0,.6); }
   .screen{ display:none; height:100svh; overflow:hidden; }
   .screen.active{ display:block; }
   #restartBtn{ display:none; margin-top:12px; }

   /* Fixed controls at bottom */
   #controls{
     position:fixed; left:0; right:0; bottom:0; z-index:999; margin:0;
     padding:10px calc(10px + env(safe-area-inset-right)) calc(10px + env(safe-area-inset-bottom)) calc(10px + env(safe-area-inset-left));
     background:rgba(0,0,0,.40);
     backdrop-filter:saturate(120%) blur(4px); -webkit-backdrop-filter:saturate(120%) blur(4px);
     display:flex; justify-content:center; align-items:center; gap:18px; flex-wrap:nowrap; width:100%;
   }
   #controls button{
     font-size:36px; padding:18px 26px; margin:4px; border-radius:14px;
     min-width:80px; min-height:80px; background:#333; color:#fff; border:2px solid #666;
     box-shadow:0 3px 8px rgba(0,0,0,.5); transition:transform .1s, background .2s;
   }
   #controls button:active{ transform:scale(.93); background:#555; }
   #controls button:disabled{ opacity:.5; cursor:not-allowed; }
   @media (max-height:640px){
     #controls button{ font-size:24px; min-width:64px; min-height:64px; padding:12px 16px; }
   }

   table{ border-collapse:collapse; margin:10px auto; width:96%; max-width:620px; }
   th,td{ border:1px solid rgba(255,255,255,.2); padding:8px 10px; text-align:left; background:rgba(0,0,0,.25); }
   th{ background:rgba(0,0,0,.35); } tr:nth-child(even) td{ background:rgba(0,0,0,.20) }
   th.sel,td.sel{ width:52px; text-align:center }
   .muted{ opacity:.9; font-size:12px; text-shadow:0 1px 3px rgba(0,0,0,.6) }
   #nameInput{ width:260px; max-width:80vw; padding:10px 12px; border-radius:8px; border:1px solid #666; background:#111; color:#fff; font-size:16px; text-align:center; }
   #playerBadge{ font-size:13px; opacity:.9; margin-top:6px; }
 </style>
</head>
<body>
 <div class="wrap">
   <h1>Tetris - Web Version</h1>

   <div class="card" style="margin-bottom:14px">
     <button id="btnMusic" class="btn small ghost" aria-pressed="false">üîá Music</button>
     <div id="audioStatus"></div>
   </div>

   <!-- NAME -->
   <section id="screen-name" class="screen active">
     <div class="card" style="min-width:340px">
       <h2>üë§ Player Name</h2>
       <p class="muted" style="max-width:520px">Enter your name once. We‚Äôll remember it and use it automatically on the Score Board.</p>
       <div style="margin:10px 0 4px"><input id="nameInput" maxlength="24" placeholder="Enter name (e.g., Afiq)"/></div>
       <div><button id="btnSaveName" class="btn primary">Save & Continue</button></div>
       <p class="muted" style="margin-top:8px">You can change this anytime from the menu.</p>
     </div>
   </section>

   <!-- MENU -->
   <section id="screen-menu" class="screen">
     <div class="card">
       <p id="playerBadge">Player: <strong id="playerNameLabel">‚Äî</strong>
         <button id="btnChangeName" class="btn small ghost" style="margin-left:8px">Change name</button>
       </p>
       <p id="loading" style="color:#ff0; min-height:1.2em">Loading engine‚Ä¶</p>
       <div style="margin-top:12px">
         <button id="btnPlay" class="btn primary">‚ñ∂ Play</button>
         <button id="btnScores" class="btn secondary">üèÜ Score Board</button>
       </div>
     </div>
   </section>

   <!-- GAME -->
   <section id="screen-game" class="screen">
     <div id="gameArea" class="card">
       <button id="btnBackFromGame" class="btn small ghost backtop">‚Üê Back to Menu</button>
       <p id="gameLoading" style="color:#ff0; min-height:1.2em; margin-top:4px">Loading game, please wait‚Ä¶</p>
       <canvas id="gameCanvas" width="300" height="600"></canvas><br/>
       <button id="restartBtn" class="btn ghost">Restart Game</button>

       <div id="controls" style="display:none">
         <button id="btnLeft"  disabled aria-label="Move left">‚óÄ</button>
         <button id="btnRight" disabled aria-label="Move right">‚ñ∂</button>
         <button id="btnDown"  disabled aria-label="Soft drop">‚ñº</button>
         <button id="btnRotate" disabled aria-label="Rotate">‚ü≥</button>
       </div>
     </div>
   </section>

   <!-- SCORES -->
   <section id="screen-scores" class="screen">
     <div class="card" style="min-width:340px">
       <h2>üèÜ Score Board</h2>
       <div class="muted" id="cloudStatus">Cloud: <em>checking‚Ä¶</em></div>
       <p class="muted">Top 10 highest scores (cloud)</p>
       <table id="scoresTable">
         <thead><tr><th class="sel">Sel</th><th>#</th><th>Name</th><th>Score</th><th>Date</th></tr></thead>
         <tbody></tbody>
       </table>
       <div>
         <button id="btnCloudClearSelected" class="btn small ghost">Clear Selected</button>
         <button id="btnCloudClearAll" class="btn small ghost">Clear Scores</button>
         <button id="btnBackFromScores" class="btn small ghost">‚Üê Back to Menu</button>
       </div>
     </div>
   </section>
 </div>
<audio id="bgm" src="bgm.mp3?v=1" loop preload="none"></audio>

 <script>
   /* --- tiny helpers / UX --- */
   var __lastTouchEnd=0;
   document.addEventListener('touchend',function(e){var n=Date.now();if(n-__lastTouchEnd<=300)e.preventDefault();__lastTouchEnd=n;},{passive:false,capture:true});

   var gameArea=document.getElementById('gameArea');
   function gameScreenIsActive(){return document.getElementById('screen-game').classList.contains('active');}
   function fitGameToViewport(){
     gameArea.style.transform='none';
     var panelW=gameArea.scrollWidth, panelH=gameArea.scrollHeight;
     var vw=Math.max(320,window.innerWidth)-8, vh=Math.max(320,window.innerHeight)-8;
     var controls=document.getElementById('controls'), ch=0;
     if(gameScreenIsActive()){
       ch=((controls&&controls.offsetHeight)?controls.offsetHeight:0)+12;
       vh=Math.max(200,vh-ch);
       gameArea.style.paddingBottom=(ch+8)+'px';
     }else{ gameArea.style.paddingBottom='8px'; }
     var scale=Math.min(1,vw/panelW,vh/panelH);
     gameArea.style.transform='scale('+scale+')';
   }
   window.addEventListener('resize',fitGameToViewport);
   window.addEventListener('orientationchange',fitGameToViewport);

   /* --- Music --- */
   var bgm=document.getElementById("bgm"), btnMusic=document.getElementById("btnMusic"), audioStatus=document.getElementById("audioStatus"), ac;
   function ensureAudioContext(){try{var C=window.AudioContext||window.webkitAudioContext;if(C&&(!ac||ac.state==="closed"))ac=new C();if(ac&&ac.state!=="running")ac.resume().catch(function(){});}catch(e){}}
   function setStatus(m){audioStatus.textContent=m||"";}
   function musicIsPlaying(){return !bgm.paused&&!bgm.ended&&bgm.currentTime>0;}
   function updateMusicUI(){var m=bgm.muted||bgm.volume===0||bgm.paused;btnMusic.textContent=m?"üîá Music":"üîä Music";btnMusic.setAttribute("aria-pressed",(!m).toString());}
   function tryStartMusic(){
     ensureAudioContext();var pref=localStorage.getItem("musicMuted");
     if(pref==="true"){updateMusicUI();setStatus("Music: muted (saved)");return;}
     bgm.muted=false;bgm.volume=0.6;
     bgm.play().then(function(){updateMusicUI();setStatus("Music: playing");})
       .catch(function(){updateMusicUI();setStatus("Music: press Music to start (autoplay)");});
   }
   function toggleMusic(){
     ensureAudioContext();
     if(musicIsPlaying()){bgm.pause();bgm.muted=true;localStorage.setItem("musicMuted","true");setStatus("Music: paused");}
     else{bgm.muted=false;bgm.volume=0.6;bgm.play().then(function(){setStatus("Music: playing");}).catch(function(){setStatus("Music: couldn't start");});localStorage.setItem("musicMuted","false");}
     updateMusicUI();
   }
   btnMusic.addEventListener("click",toggleMusic);
   bgm.addEventListener("canplaythrough",function(){setStatus("Music: loaded (ready)");});
   bgm.addEventListener("error",function(){setStatus("Music: ERROR loading bg.mp3");});
   (function(){if(localStorage.getItem("musicMuted")==="true")bgm.muted=true;updateMusicUI();var kick=function(){tryStartMusic();window.removeEventListener("pointerdown",kick);};window.addEventListener("pointerdown",kick,{once:true});})();

   /* --- Screens --- */
   function showScreen(id){
     var screens=document.querySelectorAll('.screen'); for(var i=0;i<screens.length;i++){screens[i].classList.remove('active');}
     document.getElementById(id).classList.add('active');
     var controls=document.getElementById('controls');
     controls.style.display=(id==='screen-game')?'flex':'none';
     if(id==='screen-game'){setTimeout(fitGameToViewport,0);}
   }

   /* --- Player name --- */
   var nameInput=document.getElementById('nameInput'), playerNameLabel=document.getElementById('playerNameLabel');
   function getPlayerName(){var v=localStorage.getItem('playerName');v=v?(''+v).trim():'';return v||"";}
   function setPlayerName(name){var clean=(name||"").replace(/^\s+|\s+$/g,'').slice(0,24);if(!clean)return false;localStorage.setItem('playerName',clean);playerNameLabel.textContent=clean;return true;}
   function requireNameFlowIfNeeded(){var saved=getPlayerName();if(saved){playerNameLabel.textContent=saved;showScreen('screen-menu');}else{showScreen('screen-name');setTimeout(function(){nameInput.focus();},0);}}
   document.getElementById('btnSaveName').addEventListener('click',function(){var ok=setPlayerName(nameInput.value);if(!ok){alert('Please enter a name.');return;}showScreen('screen-menu');});
   nameInput.addEventListener('keydown',function(e){if(e.key==='Enter')document.getElementById('btnSaveName').click();});
   document.getElementById('btnChangeName').addEventListener('click',function(){nameInput.value=getPlayerName();showScreen('screen-name');setTimeout(function(){nameInput.select();},0);});

   /* --- Firebase compat setup --- */
   var firebaseConfig={
     apiKey:"AIzaSyCwtCR3h3Y-KnNFGVNzMFerkapkKgBrqus",
     authDomain:"tetrist-web.firebaseapp.com",
     projectId:"tetrist-web",
     storageBucket:"tetrist-web.firebasestorage.app",
     messagingSenderId:"378076610293",
     appId:"1:378076610293:web:22ad48c19e7af8b00ccfbc",
     measurementId:"G-6JQX0TYB56"
   };
   firebase.initializeApp(firebaseConfig);
   var db=firebase.firestore();

   var ADMIN_PASSWORD="LSSIsTheBest";
   var cloudStatusEl=document.getElementById("cloudStatus");
   var tbody=document.querySelector("#scoresTable tbody");
   function escapeHtml(s){s=(s===null||s===undefined)?"":String(s);return s.replace(/[&<>\"']/g,function(c){if(c==="&")return"&amp;";if(c==="<")return"&lt;";if(c===">")return"&gt;";if(c==="\"")return"&quot;";return"&#39;"});}
   function fmt(ts){var d=(ts&&ts.seconds)?new Date(ts.seconds*1000):new Date();return d.toLocaleString([], {hour12:true,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});}

   var unsubscribeScores=null;
   var topQuery=db.collection("scores").orderBy("score","desc").limit(10);

   function attachScoresListener(){
     if(unsubscribeScores) return;
     unsubscribeScores = topQuery.onSnapshot(function(snap){
       var rows=[]; snap.forEach(function(d){var data=d.data(); data.id=d.id; rows.push(data);});
       renderRows(rows);
       cloudStatusEl.innerHTML='Cloud: <span style="color:#24d15d">online</span>';
     }, function(err){
       console.error("scores listener:",err);
       cloudStatusEl.innerHTML='Cloud: <span style="color:#f66">offline / error</span>';
       tbody.innerHTML='<tr><td class="sel"></td><td colspan="4" style="text-align:center;opacity:.7">Could not load scores (offline?)</td></tr>';
     });
   }
   function detachScoresListener(){ if(unsubscribeScores){unsubscribeScores(); unsubscribeScores=null;} }

   function renderRows(rows){
     tbody.innerHTML="";
     if(!rows.length){ tbody.innerHTML='<tr><td class="sel"></td><td colspan="4" style="text-align:center;opacity:.7">No scores yet</td></tr>'; return; }
     for(var i=0;i<rows.length;i++){
       var r=rows[i], tr=document.createElement("tr");
       tr.innerHTML='<td class="sel"><input type="checkbox" class="selbox cloud" data-docid="'+r.id+'"></td>'+
                    '<td>'+(i+1)+'</td><td>'+escapeHtml(r.name||"Player")+'</td>'+
                    '<td>'+r.score+'</td><td>'+fmt(r.createdAt)+'</td>';
       tbody.appendChild(tr);
     }
   }

   function addScoreToCloud(score){
     var name=getPlayerName()||"Player";
     return db.collection("scores").add({
       name:name, score:Number(score)||0,
       createdAt: firebase.firestore.FieldValue.serverTimestamp()
     }).catch(function(e){console.error("addScore:",e);});
   }

   function checkAdmin(label){var pw=prompt(label+"\nEnter admin password:");return pw&&pw===ADMIN_PASSWORD;}
   function disableCloudButtons(disable,cache){
     var controls=[document.getElementById("btnCloudClearSelected"),document.getElementById("btnCloudClearAll")];
     if(disable){cache=controls.map(function(b){return b.disabled;});controls.forEach(function(b){b.disabled=true;});return cache;}
     controls.forEach(function(b,i){b.disabled=cache?cache[i]:false;});
   }
   function cloudDeleteSelected(){
     if(!checkAdmin("Clear SELECTED rows?")) return;
     var btns=disableCloudButtons(true);
     var checks=Array.prototype.slice.call(document.querySelectorAll(".selbox.cloud:checked"));
     if(!checks.length){alert("Please tick at least one row."); disableCloudButtons(false,btns); return;}
     Promise.all(checks.map(function(c){return db.collection("scores").doc(c.getAttribute("data-docid")).delete();}))
       .then(function(){alert("Deleted "+checks.length+" item(s) from cloud.");})
       .catch(function(e){console.error(e);alert("Failed to delete selected (see console).");})
       .finally(function(){disableCloudButtons(false,btns);});
   }
   function cloudClearAll(){
     if(!checkAdmin("Clear ALL scores that are currently shown?")) return;
     var btns=disableCloudButtons(true);
     var ids=Array.prototype.slice.call(document.querySelectorAll(".selbox.cloud")).map(function(i){return i.getAttribute("data-docid");});
     if(!ids.length){alert("No scores to delete."); disableCloudButtons(false,btns); return;}
     Promise.all(ids.map(function(id){return db.collection("scores").doc(id).delete();}))
       .then(function(){alert("Cleared the table‚Äôs scores from cloud.");})
       .catch(function(e){console.error(e);alert("Failed to clear scores (see console).");})
       .finally(function(){disableCloudButtons(false,btns);});
   }

   /* --- Pyodide + game --- */
   var pyodide, gameCode, gameStarted=false;
   window.onGameOver=function(score){ setTimeout(function(){ addScoreToCloud(score).then(function(){ attachScoresListener(); showScreen('screen-scores'); }); },50); };

   (async function preload(){
     try{
       document.getElementById("loading").innerText="Loading engine‚Ä¶";
       pyodide=await loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"});
       var resp=await fetch("main.py?v="+Date.now(),{cache:"no-store"}); gameCode=await resp.text();
       document.getElementById("loading").innerText="Ready!";
     }catch(e){ console.error(e); document.getElementById("loading").innerText="Failed to load. See console."; }
   })();
function makeRepeater(el, fire, initialDelay, repeatEvery){
     if(initialDelay===undefined) initialDelay=220; if(repeatEvery===undefined) repeatEvery=55;
     var holding=false, repeating=false, t1=null, t2=null;
     function clear(){ if(t1){clearTimeout(t1);t1=null;} if(t2){clearInterval(t2);t2=null;} }
     function down(e){ e.preventDefault(); clear(); holding=true; repeating=false;
       t1=setTimeout(function(){ if(!holding) return; repeating=true; fire(); t2=setInterval(fire,repeatEvery); }, initialDelay);
     }
     function up(){ var tap=holding&&!repeating; holding=false; clear(); if(tap) fire(); }
     el.addEventListener('pointerdown',down,{passive:false}); el.addEventListener('pointerup',up);
     el.addEventListener('pointerleave',up); el.addEventListener('pointercancel',up);
     el.addEventListener('click',function(e){e.preventDefault();});
   }

   document.getElementById("btnPlay").addEventListener("click",async function(){
     tryStartMusic(); showScreen('screen-game'); if(gameStarted) return; gameStarted=true;
     var gl=document.getElementById("gameLoading"); gl.innerText="Starting game‚Ä¶";
     await pyodide.runPythonAsync(gameCode); gl.innerText="Game Loaded!";
     Array.prototype.forEach.call(document.querySelectorAll("#controls button"),function(b){b.disabled=false;});
     var callPy=function(c){pyodide.runPython(c);};
     document.getElementById("restartBtn").onclick=function(){location.reload();};
     makeRepeater(document.getElementById("btnLeft"),  function(){callPy('on_key({"key":"ArrowLeft"})');},130,50);
     makeRepeater(document.getElementById("btnRight"), function(){callPy('on_key({"key":"ArrowRight"})');},130,50);
     makeRepeater(document.getElementById("btnRotate"),function(){callPy('on_key({"key":"ArrowUp"})');},160,90);
     var btnDown=document.getElementById("btnDown");
     function downStart(e){e.preventDefault();callPy('start_soft_drop_hold()');}
     function downEnd(){callPy('stop_soft_drop_hold()');}
     btnDown.addEventListener("pointerdown",downStart,{passive:false});
     btnDown.addEventListener("pointerup",downEnd); btnDown.addEventListener("pointerleave",downEnd); btnDown.addEventListener("pointercancel",downEnd);
     btnDown.addEventListener("click",function(e){e.preventDefault();callPy('soft_drop_tap()');});
     fitGameToViewport();
   });

   document.getElementById("btnScores").addEventListener("click",function(){ attachScoresListener(); showScreen('screen-scores'); });
   document.getElementById("btnBackFromScores").addEventListener("click",function(){ detachScoresListener(); showScreen('screen-menu'); });
   document.getElementById("btnBackFromGame").addEventListener("click",function(){ showScreen('screen-menu'); });

   document.getElementById("btnCloudClearSelected").addEventListener("click",cloudDeleteSelected);
   document.getElementById("btnCloudClearAll").addEventListener("click",cloudClearAll);

   window.addEventListener("keydown",tryStartMusic,{once:true});
   requireNameFlowIfNeeded();
 </script>
</body>
</html>














































