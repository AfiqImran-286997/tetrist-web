<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport"
       content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
 <title>Tetris - Web Version</title>

 <!-- Pyodide -->
 <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

 <style>
   html, body {
     font-size:16px;
     touch-action:manipulation;
     -webkit-user-select:none; user-select:none;
     -webkit-touch-callout:none;
     margin:0;
     background:#000;
     color:#fff;
     min-height:100vh;
   }
   * { -webkit-tap-highlight-color: transparent; }
   .wrap, #gameArea, canvas, h1, p, table, th, td, button {
     -webkit-user-select:none; user-select:none;
   }
   :root{
     --gap: 12px;
     --logoW-desktop: 420px;
     --logoW-mobile: 70vmin;
   }
   body{ text-align:center; font-family:Arial, sans-serif; }
   .wrap { max-width:900px; margin:0 auto; padding:10px 16px; }
   h1 { margin:20px 0; text-shadow:0 2px 6px rgba(0,0,0,.6); }

   .card{
     display:inline-block;
     padding:18px;
     border-radius:10px;
     border:1px solid rgba(255,255,255,.22);
     background:rgba(0,0,0,.60);
     backdrop-filter:saturate(120%) blur(2px);
     -webkit-backdrop-filter:saturate(120%) blur(2px);
   }

   #gameArea{
     position:relative;
     background:transparent !important;
     display:inline-block;
     transform-origin: top center;
     margin-top:10px;
   }
   #gameArea::before{
     content:"";
     position:absolute; inset:0; z-index:0;
     background-repeat:no-repeat; background-position:center center;
     background-image:url("LSS%20tetris%20background.png?v=3");
     background-size: var(--logoW-desktop) auto;
     opacity:0.95; pointer-events:none;
   }
   @media (max-width:600px){
     #gameArea::before{ background-size: var(--logoW-mobile) auto; }
   }
   #gameArea > * { position:relative; z-index:1; }

   canvas{
     border:2px solid rgba(255,255,255,.85);
     margin-top:12px;
     background:transparent;
     width:300px; height:600px;
   }

   .btn { padding:12px 20px; font-size:18px; border:0; border-radius:6px; margin:6px 8px; cursor:pointer; }
   .btn.primary { background:#24d15d; color:#000; }
   .btn.secondary{ background:#2f7ded; color:#fff; }
   .btn.ghost { background:#333; color:#fff; }
   .btn.small { font-size:14px; padding:8px 12px; }

   #controls{
     margin:18px 0;
     display:flex;
     justify-content:center;
     align-items:center;
     flex-wrap:nowrap;
     gap:18px;
     width:100%;
   }
   #controls button{
     font-size:36px;
     padding:18px 26px;
     border-radius:14px;
     min-width:80px;
     min-height:80px;
     background:#333;
     color:#fff;
     border:2px solid #666;
     box-shadow:0 3px 8px rgba(0,0,0,.5);
   }

   table{ border-collapse:collapse; margin:10px auto; width:96%; max-width:620px; }
   th, td{ border:1px solid rgba(255,255,255,.2); padding:8px 10px; text-align:left; background:rgba(0,0,0,.25); }
   th{ background:rgba(0,0,0,.35); }
   tr:nth-child(even) td{ background:rgba(0,0,0,.20) }
   th.sel, td.sel{ width:52px; text-align:center }
   .muted{ opacity:.9; font-size:12px; }
 </style>
</head>

<body>
<div class="wrap">
 <h1>Tetris - Web Version</h1>

 <!-- Music -->
 <div class="card" style="margin-bottom:14px">
   <button id="btnMusic" class="btn small ghost">üîá Music</button>
   <div id="audioStatus"></div>
 </div>

 <!-- MENU -->
 <section id="screen-menu" class="screen active">
   <div class="card">
     <p id="loading" style="color:#ff0;">Loading engine‚Ä¶</p>
     <div style="margin-top:12px">
       <button id="btnPlay" class="btn primary">‚ñ∂ Play</button>
       <button id="btnScores" class="btn secondary">üèÜ Cloud Scores</button>
       <button id="btnLocalScores" class="btn ghost">üì± Local Scores</button>
     </div>
   </div>
 </section>

 <!-- GAME -->
 <section id="screen-game" class="screen">
   <div id="gameArea" class="card">
     <p id="gameLoading" style="color:#ff0;">Loading game‚Ä¶</p>
     <canvas id="gameCanvas" width="300" height="600"></canvas><br />
     <button id="restartBtn" class="btn ghost">Restart Game</button>

     <div id="controls">
       <button id="btnLeft" disabled>‚óÄ</button>
       <button id="btnRight" disabled>‚ñ∂</button>
       <button id="btnDown" disabled>‚ñº</button>
       <button id="btnRotate" disabled>‚ü≥</button>
     </div>

     <div style="margin-top:6px">
       <button id="btnBackFromGame" class="btn small ghost">‚Üê Back to Menu</button>
     </div>
   </div>
 </section>

 <!-- SCOREBOARD -->
 <section id="screen-scores" class="screen">
   <div class="card" style="min-width:340px">
     <h2>üèÜ Scores</h2>
     <div id="cloudStatus" class="muted">Status: <em>waiting‚Ä¶</em></div>
     <table id="scoresTable">
       <thead>
       <tr><th class="sel">Sel</th><th>#</th><th>Name</th><th>Score</th><th>Date</th></tr>
       </thead>
       <tbody></tbody>
     </table>

     <div>
       <button id="btnCloudClearSelected" class="btn small ghost">Clear Selected (Cloud)</button>
       <button id="btnCloudClearAll" class="btn small ghost">Clear All (Cloud)</button>
       <button id="btnLocalClearSelected" class="btn small ghost">Clear Selected (Local)</button>
       <button id="btnLocalClearAll" class="btn small ghost">Clear All (Local)</button>
       <button id="btnBackFromScores" class="btn small ghost">‚Üê Back to Menu</button>
     </div>
   </div>
 </section>
</div>
<audio id="bgm" src="bgm.mp3?v=1" loop preload="auto"></audio>

<script type="module">
// === FIREBASE ===
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
 getFirestore, collection, addDoc, serverTimestamp,
 query, orderBy, limit, deleteDoc, doc, onSnapshot
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
 apiKey: "AIzaSyCwtCR3h3Y-KnNFGVNzMFerkapkKgBrqus",
 authDomain: "tetrist-web.firebaseapp.com",
 projectId: "tetrist-web",
 storageBucket: "tetrist-web.firebasestorage.app",
 messagingSenderId: "378076610293",
 appId: "1:378076610293:web:22ad48c19e7af8b00ccfbc",
 measurementId: "G-6JQX0TYB56"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// === GLOBALS ===
const tbody = document.querySelector("#scoresTable tbody");
const cloudStatusEl = document.getElementById("cloudStatus");
const ADMIN_PASSWORD = "LSSIsTheBest";

// --- Firebase Cloud ---
let unsubscribeScores = null;
const topQuery = query(collection(db,"scores"), orderBy("score","desc"), limit(10));
function attachScoresListener(){
 if (unsubscribeScores) return;
 unsubscribeScores = onSnapshot(topQuery, snap=>{
   const rows = [];
   snap.forEach(d=>rows.push({ id:d.id, ...d.data() }));
   renderRows(rows);
   cloudStatusEl.innerHTML = 'Cloud: <span style="color:#24d15d">online</span>';
 }, err=>{
   console.error(err);
   cloudStatusEl.innerHTML = 'Cloud: <span style="color:#f66">offline/error</span>';
 });
}
function detachScoresListener(){ if (unsubscribeScores){ unsubscribeScores(); unsubscribeScores=null; } }
async function addScoreToCloud(name,score){
 try{ await addDoc(collection(db,"scores"),{name:name||"Player",score:Number(score)||0,createdAt:serverTimestamp()}); }
 catch(e){ console.error("addScore:",e); }
}
function renderRows(rows){
 tbody.innerHTML="";
 if(!rows.length){
   tbody.innerHTML='<tr><td class="sel"></td><td colspan="4" style="text-align:center;opacity:.7">No scores yet</td></tr>';
   return;
 }
 rows.forEach((r,i)=>{
   const tr=document.createElement("tr");
   tr.innerHTML=
     '<td class="sel"><input type="checkbox" class="selbox cloud" data-docid="'+r.id+'"></td>'+
     '<td>'+(i+1)+'</td>'+
     '<td>'+r.name+'</td>'+
     '<td>'+r.score+'</td>'+
     '<td>'+(r.createdAt?.seconds? new Date(r.createdAt.seconds*1000).toLocaleString(): "-")+'</td>';
   tbody.appendChild(tr);
 });
}

// --- Cloud Delete ---
function checkAdmin(lab){ const pw=prompt(lab+"\nEnter admin password:"); return pw&&pw===ADMIN_PASSWORD; }
async function cloudDeleteSelected(){
 if(!checkAdmin("Clear SELECTED?"))return;
 const checks=document.querySelectorAll(".selbox.cloud:checked");
 for(const c of checks){ await deleteDoc(doc(db,"scores",c.getAttribute("data-docid"))); }
 alert("Selected deleted.");
}
async function cloudClearAll(){
 if(!checkAdmin("Clear ALL cloud scores?"))return;
 const all=document.querySelectorAll(".selbox.cloud");
 for(const c of all){ await deleteDoc(doc(db,"scores",c.getAttribute("data-docid"))); }
 alert("All cleared.");
}

// === LOCAL SCORES ===
const LS_KEY='tetrist_local_scores_v1';
function getLocalScores(){ try{return JSON.parse(localStorage.getItem(LS_KEY))||[];}catch{return[];} }
function setLocalScores(list){ localStorage.setItem(LS_KEY,JSON.stringify(list.slice(0,50))); }
function addLocalScore(name,score){
 const list=getLocalScores();
 list.push({name:name||'Player',score:Number(score)||0,createdAt:Date.now()});
 list.sort((a,b)=>b.score-a.score);
 setLocalScores(list);
}
function renderLocalScores(){
 detachScoresListener?.();
 const rows=getLocalScores().slice(0,10);
 tbody.innerHTML="";
 if(!rows.length){
   tbody.innerHTML='<tr><td class="sel"></td><td colspan="4" style="text-align:center;opacity:.7">No local scores</td></tr>';
   cloudStatusEl.innerHTML='Local: <span style="color:#24d15d">device</span>';
   return;
 }
 rows.forEach((r,i)=>{
   const tr=document.createElement("tr");
   tr.innerHTML=
     '<td class="sel"><input type="checkbox" class="selbox local" data-index="'+i+'"></td>'+
     '<td>'+(i+1)+'</td>'+
     '<td>'+r.name+'</td>'+
     '<td>'+r.score+'</td>'+
     '<td>'+new Date(r.createdAt).toLocaleString()+'</td>';
   tbody.appendChild(tr);
 });
 cloudStatusEl.innerHTML='Local: <span style="color:#24d15d">device</span>';
}
function localDeleteSelected(){
 const checks=Array.from(document.querySelectorAll(".selbox.local:checked"));
 if(!checks.length){alert("Tick at least one.");return;}
 const idxs=checks.map(c=>Number(c.dataset.index)).sort((a,b)=>b-a);
 const list=getLocalScores();
 idxs.forEach(i=>{if(i>=0&&i<list.length)list.splice(i,1);});
 setLocalScores(list);
 renderLocalScores();
}
function localClearAll(){
 if(!confirm("Clear ALL local scores?"))return;
 localStorage.removeItem(LS_KEY);
 renderLocalScores();
}

// === PYODIDE GAME ===
let pyodide, gameCode, gameStarted=false;
window.onGameOver = async (score, reason)=>{
 const nice=reason==="timeup"?"Time Up!":"Game Over!";
 setTimeout(async()=>{
   const name=prompt(nice+"\nYour score: "+score+"\nEnter your name:")||"Player";
   addLocalScore(name,score);
   await addScoreToCloud(name,score);
   attachScoresListener();
   showScreen('screen-scores');
 },50);
};

async function preloadEngine(){
 try{
   pyodide=await loadPyodide({ indexURL:"https://cdn.jsdelivr.net/pyodide/v0.23.4/full/" });
   const resp=await fetch("main.py?v="+Date.now(),{cache:"no-store"});
   gameCode=await resp.text();
   document.getElementById("loading").innerText="Ready!";
 }catch(e){document.getElementById("loading").innerText="Load failed";}
}
preloadEngine();

// === MUSIC ===
const bgm=document.getElementById("bgm");
document.getElementById("btnMusic").addEventListener("click",()=>{
 if(bgm.paused){bgm.volume=0.6;bgm.play();}else{bgm.pause();}
});

// === SCREENS ===
function showScreen(id){
 document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
 document.getElementById(id).classList.add('active');
}

// === BUTTONS ===
document.getElementById("btnPlay").addEventListener("click",async()=>{
 showScreen('screen-game');
 if(gameStarted)return;
 gameStarted=true;
 const gl=document.getElementById("gameLoading");
 gl.innerText="Starting...";
 await pyodide.runPythonAsync(gameCode);
 gl.innerText="Game Loaded!";
 document.querySelectorAll("#controls button").forEach(b=>b.disabled=false);
});
document.getElementById("btnScores").addEventListener("click",()=>{attachScoresListener();showScreen('screen-scores');});
document.getElementById("btnLocalScores").addEventListener("click",()=>{renderLocalScores();showScreen('screen-scores');});
document.getElementById("btnBackFromScores").addEventListener("click",()=>{detachScoresListener();showScreen('screen-menu');});
document.getElementById("btnBackFromGame").addEventListener("click",()=>location.reload());
document.getElementById("btnCloudClearSelected").addEventListener("click",cloudDeleteSelected);
document.getElementById("btnCloudClearAll").addEventListener("click",cloudClearAll);
document.getElementById("btnLocalClearSelected").addEventListener("click",localDeleteSelected);
document.getElementById("btnLocalClearAll").addEventListener("click",localClearAll);
</script>
</body>
</html>






































