<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta
   name="viewport"
   content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
 />
 <title>Tetris - Web Version</title>

 <!-- Pyodide (Python-in-the-browser) -->
 <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

 <style>
   html, body { font-size:16px; touch-action:manipulation; }
   button, input, select, textarea {
     touch-action:manipulation; -webkit-touch-callout:none;
     -webkit-tap-highlight-color:transparent; -webkit-user-select:none; user-select:none;
   }
   :root { --gap: 12px; }
   body { background:#000; color:#fff; font-family:Arial, sans-serif; text-align:center; margin:0 }
   h1 { margin:20px 0 }
   .btn { padding:12px 20px; font-size:18px; border:0; border-radius:6px; margin:6px 8px; cursor:pointer }
   .btn.primary { background:#24d15d; color:#000 }
   .btn.secondary { background:#2f7ded; color:#fff }
   .btn.ghost { background:#333; color:#fff }
   .btn.small { font-size:14px; padding:8px 12px }
   .wrap { max-width:900px; margin:0 auto; padding:10px 16px }
   .card { display:inline-block; background:#111; padding:18px; border:1px solid #444; border-radius:10px }
   #loading { color:#ff0; font-size:18px; min-height:1.4em }
   #audioStatus { font:12px/1.2 Arial, sans-serif; color:#ccc; min-height:1.2em; margin-top:6px }
   .screen { display:none } .screen.active { display:block }
   #gameArea { margin-top:10px }
   canvas { border:2px solid #fff; margin-top:12px }
   #restartBtn { display:none; margin-top:12px }
   #controls { margin:16px 0; display:flex; gap:var(--gap); justify-content:center; flex-wrap:wrap }
   #controls button { font-size:24px; padding:10px 14px; margin:2px }
   #controls button.small { font-size:16px }
   #controls button:disabled { opacity:.5; cursor:not-allowed }
   table { border-collapse:collapse; margin:10px auto; width:96%; max-width:640px }
   th, td { border:1px solid #555; padding:8px 10px; text-align:left }
   th { background:#1b1b1b }
   tr:nth-child(even) td { background:#141414 }
   th.sel, td.sel { width:52px; text-align:center }
   .note { font-size:12px; opacity:.65; margin-top:6px }
 </style>
</head>
<body>
 <div class="wrap">
   <h1>Tetris - Web Version</h1>

   <!-- GLOBAL: Music control -->
   <div class="card" style="margin-bottom:14px">
     <button id="btnMusic" class="btn small ghost" aria-pressed="false" title="Toggle music">üîá Music</button>
     <div id="audioStatus"></div>
   </div>

   <!-- ===== MENU SCREEN ===== -->
   <section id="screen-menu" class="screen active">
     <div class="card">
       <p id="loading">Loading engine‚Ä¶</p>
       <div style="margin-top:12px">
         <button id="btnPlay" class="btn primary">‚ñ∂ Play</button>
         <button id="btnScores" class="btn secondary">üèÜ Score Board</button>
       </div>
     </div>
   </section>

   <!-- ===== GAME SCREEN ===== -->
   <section id="screen-game" class="screen">
     <div id="gameArea" class="card">
       <p id="gameLoading" style="color:#ff0; min-height:1.2em">Loading game, please wait‚Ä¶</p>
       <canvas id="gameCanvas" width="300" height="600"></canvas><br />
       <button id="restartBtn" class="btn ghost">Restart Game</button>

       <!-- On-screen controls (mobile) -->
       <div id="controls">
         <button id="btnLeft"  disabled aria-label="Move left">‚óÄ</button>
         <button id="btnRight" disabled aria-label="Move right">‚ñ∂</button>
         <button id="btnDown"  disabled aria-label="Soft drop">‚ñº</button>
         <button id="btnRotate" disabled aria-label="Rotate">‚ü≥</button>
       </div>

       <div style="margin-top:6px">
         <button id="btnBackFromGame" class="btn small ghost">‚Üê Back to Menu</button>
       </div>
     </div>
   </section>

   <!-- ===== SCORE BOARD ===== -->
   <section id="screen-scores" class="screen">
     <div class="card" style="min-width:340px">
       <h2>üèÜ Score Board</h2>
       <p style="opacity:.8">Top 10 highest scores (cloud)</p>

       <table id="scoresTable">
         <thead>
         <tr>
           <th class="sel">Sel</th>
           <th>#</th><th>Name</th><th>Score</th><th>Date</th>
         </tr>
         </thead>
         <tbody></tbody>
       </table>

       <div>
         <button id="btnClearSelected" class="btn small ghost">Clear Selected</button>
         <button id="btnClearScores"   class="btn small ghost">Clear Scores</button>
         <button id="btnBackFromScores" class="btn small ghost">‚Üê Back to Menu</button>
       </div>
       <p class="note">(Admin password for clearing: <code>LSSIsTheBest</code>)</p>
     </div>
   </section>
 </div>
<!-- Background music (place bgm.mp3 beside this file) -->
 <audio id="bgm" src="bgm.mp3?v=1" loop preload="auto"></audio>

 <!-- Main app logic (ES module so we can import Firebase) -->
 <script type="module">
   /************ Firebase (CDN modular SDK) ************/
   import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
   import {
     getFirestore, collection, addDoc, serverTimestamp,
     query, orderBy, limit, getDocs, deleteDoc, doc
   } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

   // TODO: paste YOUR exact config from the console here:
const firebaseConfig = {
  apiKey: "AIzaSyCwtCR3h3Y-KnNFGVNzMFerkapkKgBrqus",
  authDomain: "tetrist-web.firebaseapp.com",
  projectId: "tetrist-web",
  storageBucket: "tetrist-web.firebasestorage.app",
  messagingSenderId: "378076610293",
  appId: "1:378076610293:web:22ad48c19e7af8b00ccfbc",
  measurementId: "G-6JQX0TYB56"
};

   const app = initializeApp(firebaseConfig);
   const db  = getFirestore(app);
   const scoresCol = collection(db, "scores");   // we‚Äôll create this implicitly

   /************ Simple screen switcher ************/
   function showScreen(id) {
     document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
     document.getElementById(id).classList.add('active');
   }

   /************ Music helpers ************/
   const bgm = document.getElementById("bgm");
   const btnMusic = document.getElementById("btnMusic");
   const audioStatus = document.getElementById("audioStatus");
   let ac;

   function ensureAudioContext() {
     try {
       const Ctx = window.AudioContext || window.webkitAudioContext;
       if (Ctx && (!ac || ac.state === "closed")) ac = new Ctx();
       if (ac && ac.state !== "running") ac.resume().catch(()=>{});
     } catch(e) {}
   }
   function setStatus(msg){ audioStatus.textContent = msg || ""; }
   function updateMusicUI(){
     const mutedOrPaused = bgm.muted || bgm.volume === 0 || bgm.paused;
     btnMusic.textContent = mutedOrPaused ? "üîá Music" : "üîä Music";
     btnMusic.setAttribute("aria-pressed", (!mutedOrPaused).toString());
   }
   async function tryStartMusic(){
     ensureAudioContext();
     const pref = localStorage.getItem("musicMuted");
     if (pref === "true") { updateMusicUI(); setStatus("Music: muted (saved)"); return; }
     try {
       bgm.muted = false; bgm.volume = 0.6; await bgm.play();
       updateMusicUI(); setStatus("Music: playing");
     } catch { updateMusicUI(); setStatus("Music: press Music to start (autoplay)"); }
   }
   function toggleMusic(){
     ensureAudioContext();
     if (!bgm.paused && !bgm.ended && bgm.currentTime > 0) {
       bgm.pause(); bgm.muted = true; localStorage.setItem("musicMuted","true"); setStatus("Music: paused");
     } else {
       bgm.muted = false; bgm.volume = 0.6;
       bgm.play().then(()=>setStatus("Music: playing")).catch(()=>setStatus("Music: couldn't start"));
       localStorage.setItem("musicMuted","false");
     }
     updateMusicUI();
   }
   bgm.addEventListener("canplaythrough", () => setStatus("Music: loaded (ready)"));
   bgm.addEventListener("error", () => setStatus("Music: ERROR loading bgm.mp3"));
   (function initMusicPref(){
     const pref = localStorage.getItem("musicMuted");
     if (pref === "true") bgm.muted = true;
     updateMusicUI();
     const kick = () => { tryStartMusic(); window.removeEventListener("pointerdown", kick); };
     window.addEventListener("pointerdown", kick, { once:true });
   })();
   btnMusic.addEventListener("click", toggleMusic);

   /************ Firestore helpers ************/
   const ADMIN_PASSWORD = "LSSIsTheBest";

   async function saveScoreToCloud(name, score){
     try {
       await addDoc(scoresCol, {
         name: String(name || "Player").slice(0,40),
         score: Number(score) || 0,
         createdAt: serverTimestamp(),
         ua: navigator.userAgent || "",
         platform: navigator.platform || ""
       });
     } catch (e) {
       console.warn("Cloud save failed (will still keep local):", e);
     }
   }

   async function fetchTopScoresAndRender(){
     const tbody = document.querySelector("#scoresTable tbody");
     tbody.innerHTML = `<tr><td class="sel"></td><td colspan="4" style="text-align:center;opacity:.7">Loading‚Ä¶</td></tr>`;
     try {
       const qTop = query(scoresCol, orderBy("score","desc"), orderBy("createdAt","desc"), limit(10));
       const snap = await getDocs(qTop);
       const rows = [];
       let i = 1;
       snap.forEach(docu => {
         const d = docu.data();
         rows.push({
           id: docu.id,
           idx: i++,
           name: d.name || "Player",
           score: d.score || 0,
           date: d.createdAt?.toDate?.() || new Date()
         });
       });
       if (rows.length === 0) {
         tbody.innerHTML = `<tr><td class="sel"></td><td colspan="4" style="text-align:center;opacity:.7">No scores yet</td></tr>`;
         return;
       }
       tbody.innerHTML = rows.map(r => `
         <tr>
           <td class="sel"><input type="checkbox" class="selbox" data-id="${r.id}"></td>
           <td>${r.idx}</td>
           <td>${escapeHtml(r.name)}</td>
           <td>${r.score}</td>
           <td>${r.date.toLocaleDateString()} ${r.date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
         </tr>
       `).join("");
     } catch (e) {
       console.error(e);
       tbody.innerHTML = `<tr><td class="sel"></td><td colspan="4" style="text-align:center;opacity:.7">Could not load scores (offline?).</td></tr>`;
     }
   }

   function escapeHtml(s){ return (s??"").toString().replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }
   function promptPassword(label){ return prompt(`${label}\nEnter admin password:`) === ADMIN_PASSWORD; }

   document.getElementById("btnClearScores").addEventListener("click", async ()=>{
     if (!promptPassword("Clear ALL scores (cloud)")) return alert("Wrong password.");
     if (!confirm("Delete ALL scores from Firestore?")) return;
     // Delete top 1000 (safety pass)
     const snap = await getDocs(query(scoresCol, orderBy("createdAt","desc"), limit(1000)));
     const ops = [];
     snap.forEach(d => ops.push(deleteDoc(doc(db,"scores", d.id))));
     await Promise.allSettled(ops);
     await fetchTopScoresAndRender();
     alert("All scores cleared.");
   });

   document.getElementById("btnClearSelected").addEventListener("click", async ()=>{
     const checks = [...document.querySelectorAll(".selbox:checked")];
     if (checks.length === 0) return alert("Please tick at least one score to clear.");
     if (!promptPassword("Clear SELECTED scores (cloud)")) return alert("Wrong password.");
     await Promise.allSettled(checks.map(c => deleteDoc(doc(db,"scores", c.dataset.id))));
     await fetchTopScoresAndRender();
     alert("Selected scores cleared.");
   });

   document.getElementById("btnBackFromScores").addEventListener("click", ()=> showScreen('screen-menu'));

   /************ Pyodide + Game ************/
   let pyodide, gameCode, gameStarted = false;

   async function preloadEngine(){
     try {
       document.getElementById("loading").innerText = "Loading engine‚Ä¶";
       pyodide  = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/" });
       const resp = await fetch("main.py?v=" + Date.now(), { cache:"no-store" });
       gameCode = await resp.text();
       document.getElementById("loading").innerText = "Ready!";
     } catch (e) {
       console.error(e);
       document.getElementById("loading").innerText = "Failed to load. See console.";
     }
   }
   preloadEngine();

   // Called by Python when a round ends
   window.onGameOver = async function(score, reason){
     const nice = (reason === "timeup") ? "Time Up!" : "Game Over!";
     setTimeout(async ()=>{
       const name = prompt(`${nice}\nYour score: ${score}\nEnter your name for the Score Board:`) || "Player";
       // Save to cloud (primary) ‚Äî also keep a tiny local backup just in case
       try { await saveScoreToCloud(name, score); } catch(e){}
       let backup = [];
       try { backup = JSON.parse(localStorage.getItem("tetrisScores")||"[]"); } catch {}
       backup.push({ name, score, date: new Date().toISOString() });
       localStorage.setItem("tetrisScores", JSON.stringify(backup.slice(-50)));
       await fetchTopScoresAndRender();
       showScreen('screen-scores');
     }, 60);
   };

   // Play: start Python game once
   document.getElementById("btnPlay").addEventListener("click", async ()=>{
     tryStartMusic();
     showScreen('screen-game');
     if (gameStarted) return;
     gameStarted = true;

     const gl = document.getElementById("gameLoading");
     gl.innerText = "Starting game‚Ä¶";
     await pyodide.runPythonAsync(gameCode);
     gl.innerText = "Game Loaded!";

     // Enable on-screen buttons
     document.querySelectorAll("#controls button").forEach(b => b.disabled = false);

     // Hook on-screen control events to Python
     const callPy = c => pyodide.runPython(c);
     document.getElementById("restartBtn").onclick = () => location.reload();

     document.getElementById("btnLeft") .addEventListener("click", () => callPy(`on_key({"key":"ArrowLeft"})`));
     document.getElementById("btnRight").addEventListener("click", () => callPy(`on_key({"key":"ArrowRight"})`));
     document.getElementById("btnRotate").addEventListener("click", () => callPy(`on_key({"key":"ArrowUp"})`));

     // Down (hold + tap)
     const btnDown = document.getElementById("btnDown");
     const downStart = () => { callPy(`start_soft_drop_hold()`); };
     const downEnd   = () => { callPy(`stop_soft_drop_hold()`); };
     btnDown.addEventListener("mousedown", downStart);
     btnDown.addEventListener("mouseup",   downEnd);
     btnDown.addEventListener("mouseleave",downEnd);
     btnDown.addEventListener("touchstart",(e)=>{ e.preventDefault(); downStart(); }, {passive:false});
     btnDown.addEventListener("touchend",  (e)=>{ e.preventDefault(); downEnd();   }, {passive:false});
     btnDown.addEventListener("touchcancel",(e)=>{ e.preventDefault(); downEnd();  }, {passive:false});
     btnDown.addEventListener("click", () => callPy(`soft_drop_tap()`));
   });

   // Menu nav
   document.getElementById("btnScores").addEventListener("click", ()=>{
     fetchTopScoresAndRender(); showScreen('screen-scores');
   });
   document.getElementById("btnBackFromGame").addEventListener("click", ()=> location.reload());
   window.addEventListener("keydown", tryStartMusic, { once:true });
 </script>
</body>
</html>
