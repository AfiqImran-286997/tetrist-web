<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
     content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Tetris - Web Version</title>

<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

<style>
 body { background:#000; color:#fff; font-family:Arial, sans-serif; text-align:center; margin:0; }
 h1 { margin:20px 0; }
 .btn { padding:12px 20px; font-size:18px; border:0; border-radius:6px; margin:6px 8px; cursor:pointer; }
 .btn.primary { background:#24d15d; color:#000; }
 .btn.secondary { background:#2f7ded; color:#fff; }
 .btn.ghost { background:#333; color:#fff; }
 .btn.small { font-size:14px; padding:8px 12px; }
 .wrap { max-width:900px; margin:0 auto; padding:10px 16px; }
 .card { display:inline-block; background:#111; padding:18px; border:1px solid #444; border-radius:10px; }
 .screen { display:none; }
 .screen.active { display:block; }
 table { border-collapse:collapse; margin:10px auto; width:96%; max-width:620px; }
 th, td { border:1px solid #555; padding:8px 10px; text-align:left; }
 th { background:#1b1b1b; }
 tr:nth-child(even) td { background:#141414; }
 th.sel, td.sel { width:52px; text-align:center; }
 .muted { opacity:.75; font-size:12px; }
</style>
</head>
<body>
<div class="wrap">
 <h1>Tetris - Web Version</h1>

 <div class="card" style="margin-bottom:14px">
   <button id="btnMusic" class="btn small ghost">üîá Music</button>
   <div id="audioStatus"></div>
 </div>

 <section id="screen-menu" class="screen active">
   <div class="card">
     <p id="loading">Loading engine‚Ä¶</p>
     <div style="margin-top:12px">
       <button id="btnPlay" class="btn primary">‚ñ∂ Play</button>
       <button id="btnScores" class="btn secondary">üèÜ Score Board</button>
     </div>
   </div>
 </section>

 <section id="screen-game" class="screen">
   <div class="card">
     <p id="gameLoading" style="color:#ff0;">Loading game, please wait‚Ä¶</p>
     <canvas id="gameCanvas" width="300" height="600"></canvas><br>
     <button id="restartBtn" class="btn ghost">Restart Game</button><br>
     <button id="btnBackFromGame" class="btn small ghost">‚Üê Back to Menu</button>
   </div>
 </section>

 <section id="screen-scores" class="screen">
   <div class="card" style="min-width:340px">
     <h2>üèÜ Score Board</h2>
     <div class="muted" id="cloudStatus">Cloud: <em>checking‚Ä¶</em></div>
     <p class="muted">Top 10 highest scores</p>
     <table id="scoresTable">
       <thead>
         <tr>
           <th class="sel">Sel</th><th>#</th><th>Name</th><th>Score</th><th>Date</th>
         </tr>
       </thead>
       <tbody></tbody>
     </table>
     <div>
       <button id="btnCloudClearSelected" class="btn small ghost">Clear Selected</button>
       <button id="btnCloudClearAll" class="btn small ghost">Clear Scores</button>
       <button id="btnBackFromScores" class="btn small ghost">‚Üê Back to Menu</button>
     </div>
     <p class="muted">(Admin password: <code>LSSIsTheBest</code>)</p>
   </div>
 </section>
</div>

<audio id="bgm" src="bgm.mp3" loop preload="auto"></audio>

<script type="module">
 /* ---------------- Firebase ---------------- */
 import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
 import {
   initializeFirestore, collection, addDoc, serverTimestamp,
   deleteDoc, doc, getDocs, query, orderBy, limit
 } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

 const firebaseConfig = {
   apiKey: "AIzaSyCwTCR3h3Yy-KnNFGVNZmFerkapkKGbrqus",
   authDomain: "tetr1st-web.firebaseapp.com",
   projectId: "tetr1st-web",
   storageBucket: "tetr1st-web.firebasestorage.app",
   messagingSenderId: "378076610293",
   appId: "1:378076610293:web:22ad48619e7af8b0e0cfbc",
   measurementId: "G-6J0XQTYB56"
 };
 const app = initializeApp(firebaseConfig);

 // ‚úÖ FIX: Only use experimentalForceLongPolling (no conflict)
 const db = initializeFirestore(app, {
   experimentalForceLongPolling: true,
   useFetchStreams: false
 });

 /* ---------------- Scoreboard ---------------- */
 const ADMIN_PASSWORD = "LSSIsTheBest";
 const tbody = document.querySelector("#scoresTable tbody");
 const cloudStatus = document.getElementById("cloudStatus");

 function fmt(ts) {
   return new Date(ts?.seconds ? ts.seconds * 1000 : Date.now()).toLocaleString();
 }

 async function loadScores() {
   try {
     const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(10));
     const snap = await getDocs(q);
     const rows = [];
     snap.forEach(d => {
       const v = d.data();
       rows.push({
         id: d.id,
         name: v.name || "Player",
         score: v.score,
         createdAt: v.createdAt
       });
     });
     renderScores(rows);
     cloudStatus.innerHTML = "Cloud: ‚úÖ online";
   } catch (e) {
     console.error(e);
     cloudStatus.innerHTML = "Cloud: ‚ùå error";
   }
 }

 function renderScores(rows) {
   tbody.innerHTML = "";
   if (!rows.length) {
     tbody.innerHTML = `<tr><td></td><td colspan="4" style="text-align:center;">No scores yet</td></tr>`;
     return;
   }
   rows.forEach((r, i) => {
     const tr = document.createElement("tr");
     tr.innerHTML = `<td><input type="checkbox" data-id="${r.id}"></td>
                     <td>${i + 1}</td><td>${r.name}</td>
                     <td>${r.score}</td><td>${fmt(r.createdAt)}</td>`;
     tbody.appendChild(tr);
   });
 }

 async function addScoreToCloud(name, score) {
   try {
     await addDoc(collection(db, "scores"), {
       name: name || "Player",
       score: Number(score) || 0,
       createdAt: serverTimestamp()
     });
     console.log("‚úÖ Score saved");
   } catch (e) {
     console.error("‚ùå Save failed", e);
     alert("Could not save your score.");
   }
 }

 async function clearSelected() {
   const pw = prompt("Enter admin password:");
   if (pw !== ADMIN_PASSWORD) return alert("Wrong password.");
   const ids = Array.from(document.querySelectorAll("input[type=checkbox]:checked"))
     .map(c => c.dataset.id);
   for (const id of ids) await deleteDoc(doc(db, "scores", id));
   alert("Deleted selected.");
   loadScores();
 }

 async function clearAll() {
   const pw = prompt("Enter admin password:");
   if (pw !== ADMIN_PASSWORD) return alert("Wrong password.");
   const ids = Array.from(document.querySelectorAll("input[type=checkbox]"))
     .map(c => c.dataset.id);
   for (const id of ids) await deleteDoc(doc(db, "scores", id));
   alert("Cleared all.");
   loadScores();
 }

 document.getElementById("btnCloudClearSelected").onclick = clearSelected;
 document.getElementById("btnCloudClearAll").onclick = clearAll;
 document.getElementById("btnScores").onclick = () => { show("screen-scores"); loadScores(); };
 document.getElementById("btnBackFromScores").onclick = () => show("screen-menu");
 document.getElementById("btnBackFromGame").onclick = () => show("screen-menu");

 /* ---------------- Screen switching ---------------- */
 function show(id) {
   document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
   document.getElementById(id).classList.add("active");
 }

 /* ---------------- Game integration ---------------- */
 let pyodide, code, started = false;
window.onGameOver = async (score) => {
   const name = prompt(`Game Over!\nYour score: ${score}\nEnter your name:`) || "Player";
   await addScoreToCloud(name, score);
   show("screen-scores");
   loadScores();
 };

 async function preload() {
   try {
     document.getElementById("loading").innerText = "Loading engine‚Ä¶";
     pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/" });
     const res = await fetch("main.py?v=" + Date.now());
     code = await res.text();
     document.getElementById("loading").innerText = "Ready!";
   } catch (e) {
     console.error(e);
     document.getElementById("loading").innerText = "Failed to load engine.";
   }
 }
 preload();

 document.getElementById("btnPlay").onclick = async () => {
   show("screen-game");
   if (started) return;
   started = true;
   document.getElementById("gameLoading").innerText = "Starting‚Ä¶";
   await pyodide.runPythonAsync(code);
   document.getElementById("gameLoading").innerText = "Game loaded!";
 };
</script>
</body>
</html>






